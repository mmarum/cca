{% extends "base-site.html" %}
{% block title %}Catalyst Creative Arts Cart{% endblock %}

{% block html_head %}
<style>
.product_price, .product_total {
  /*
  padding-left: 40px;
  padding-right: 40px;
  */
}
form, input {
  display: inline;
}
.product_image {
  max-width: 100%;
}
#cart {
  width: 50px;
}
#add_to_cart {
  margin: 10px;
  padding: 10px;
  width: 220px;
  border: 1px dashed LightGray;
  border-radius: 15px;
  background-color: HoneyDew;
}
#add_to_cart a {
  text-decoration: none;
}
#product_quantity_select {
  margin-top: 10px;
  max-width: 60px;
}
img.check {
  width: 35px;
  padding-left: 10px;
}
.form-control {
  display: inline;
}
.plus_minus {
  font-size: 20px;
}
#add_to_cart_text {
  margin-left: 3px;
  padding-left: 3px;
}
.top-buffer {
  padding: 10px 0 10px 0;
  margin: 10px 0 10px 0;
  /* border-bottom: 1px dashed LightGray; */
}
#cart_sum_top, #cart_sum_bottom {
  text-align: right;
  border: 20px;
}
</style>
{% endblock %}

{% block content %}

<div class="row">

<div class="col-sm-1">
</div>

<div class="col-md-10">
  <div id="cart_sum_top">
    Checkout Subtotal: $
  </div>
  <div id="cart_contents">
  </div>
  <div id="cart_sum_bottom">
    Checkout Subtotal: $
  </div>
  <div>
  <a href="/app/products">More shopping</a>
  </div>
</div>

<div class="col-sm-1">
</div>

</div>

<script>
function make_request_get_list(session_id) {
  fetch('/cart-api/list', {
    method: 'POST',
    headers: {
      'content-type': 'application/json'
    },
    body: JSON.stringify({
      session_id: session_id
    })
  })
  .then(response=>response.json())
  .then(data=>{
    //console.log(data); 

    var arrLen = data.length;
    var product_total_sum = 0;
    var lines = '';
    for (var i = 0; i < arrLen; i++) {
      //console.log(data[i]);
      obj = data[i];
      //console.log(obj.name);
      product_image = '<img src="/img/small/' + obj.image_path_array.split(',')[1] + '" class="product_image"/>';
      product_name = obj.name.toLowerCase().replace(' ', '-');
      product_total = obj.price * obj.quantity;
      //line = product_image + ' ' + obj.name + ' price: $' + obj.price + ' quantity: ' + obj.quantity + ' $' + product_total;

      var line = `
<div class="row top-buffer">
<div class="col-sm-1"></div>
<div class="col-md-2">
<a href="">${product_image}</a>
</div>
<div class="col-lg-8">
<a href="/app/products/${product_name}/${obj.pid}"><h3>${obj.name}</h3></a>
<div class="product_price">$${obj.price}</div>
<div>

<form action="" id="product_quantity_form">
<select name="quantity" id="product_quantity_select" class="form-control" onclick="updateQuantity(${obj.pid}, this.options[this.selectedIndex].value);">
<option value=${obj.quantity}>${obj.quantity}</option>
<option value=0>0</option>
<option value=1>1</option>
<option value=2>2</option>
<option value=3>3</option>
<option value=4>4</option>
<option value=5>5</option>
<option value=6>6</option>
<option value=7>7</option>
<option value=8>8</option>
<option value=9>9</option>
<option value=10>10</option>
</select>
</form>

</div>
</div>
<div class="col-sm-1"></div>
</div>
`;

      lines += line;
      product_total_sum += product_total;
    }
    document.getElementById("cart_sum_top").innerHTML += product_total_sum;
    document.getElementById("cart_contents").innerHTML = lines;
    document.getElementById("cart_sum_bottom").innerHTML += product_total_sum;
  })
}

function getCartList() {
  // FIRST CHECK IF USER HAS SESSION COOKIE
  var session_id = document.cookie.split("=")[1];
  if (session_id) {
    console.log(session_id)
    // MAKE A REQUEST TO THE NEW CART API
    console.log("request to cart api for list");
    make_request_get_list(session_id);
  } else {
    console.log("No session_id");
  }
}

getCartList();

function plusMinus(n) {
  v = document.getElementById("product_quantity_select").value;
  x = (Number(v) + Number(n));
  document.getElementById("product_quantity_select").value = x;
  return false;
}

function make_request(session_id, product_id, quantity) {
  const fetchPromise = fetch('/cart-api/update', {
    method: 'POST',
    headers: {
      'content-type': 'application/json'
    },
    body: JSON.stringify({
      session_id: session_id,
      product_id: product_id,
      quantity: quantity
    })
  });
  fetchPromise.then(response => {
    make_request_get_total(session_id);
    console.log("response from promise");
    //console.log(response);
  });
}

function updateQuantity(pid, quantity) {
  console.log(pid);
  console.log(quantity);
  // GRAB THE QUANTITY FROM FORM
  //quantity = document.getElementById("product_quantity_select").value;
  //console.log(quantity);
  if (quantity == 0) {
    // REMOVE ITEM FROM CART LIST
  } else {
    var session_id = document.cookie.split("=")[1];
    if (session_id) {
      console.log(session_id)
      // MAKE A REQUEST TO CART API
      console.log("request to cart api to update quantity");
      make_request(session_id, pid, quantity);
    } else {
      console.log("Error. Still no session_id");
    }
  }
  return false;
}

</script>


{% endblock %}
